<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Visualizador de Modelos 3D (three.js)</title>
  <style>
    body { margin: 0; background: #101820; color: #fff; font-family: Arial, sans-serif; }
    #viewer { width: 100vw; height: 100vh; display: block; }
    #controls {
      position: absolute; top: 10px; left: 10px; z-index: 10;
      background: rgba(0,0,0,0.7); padding: 10px; border-radius: 8px;
    }
    select, button { font-size: 16px; margin: 5px; }
  </style>
</head>
<body>
  <div id="controls">
    <label for="model-select">Escolha o modelo:</label>
    <select id="model-select">
      <option value="assets/icon_3d_python/Pbr/base_basic_pbr.glb">icone python 3D (GLB)</option>
      <option value="assets/tool_box/Pbr/base_basic_pbr.glb">caixa de ferramentas (GLB)</option>
      <option value="assets/gpu_nvidia/Pbr/base_basic_pbr.glb">GPU NVIDIA (GLB)</option>
      <option value="assets/dra_ana_turing/Pbr/base_basic_pbr.glb">Dra. Ana Turing (GLB)</option>
      <option value="assets/dra_ana_turing_realista/character.fbx">Dra. Ana Turing Realista (FBX)</option>
      <option value="assets/servidor/scene.gltf">Servidor (GLTF)</option>
    </select>
    <button id="load-model-btn">Carregar Modelo</button>
  </div>
  <div id="viewer"></div>
  <div id="error-panel" style="position:fixed;top:70px;left:10px;z-index:20;background:rgba(200,0,0,0.85);color:#fff;padding:10px 18px;border-radius:8px;display:none;max-width:400px;font-size:16px;"></div>
  
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>
  
  <script type="module">
    // Aviso para o usuário caso não esteja usando um servidor local
    if (location.protocol === 'file:') {
      alert('⚠️ Para visualizar modelos 3D, utilize um servidor local (ex: python -m http.server 8000) e acesse via http://localhost:8000. Abrir o arquivo diretamente não funciona com módulos ES6.');
    }
    
    // Importações usando import map
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';
    
    console.log('✅ Three.js carregado com sucesso!');
    
    // Variáveis globais
    let scene, camera, renderer, controls, currentModel;
    
    // Função para mostrar erros
    function showError(msg) {
      const panel = document.getElementById('error-panel');
      if (msg) {
        panel.textContent = msg;
        panel.style.display = 'block';
      } else {
        panel.textContent = '';
        panel.style.display = 'none';
      }
    }
    
    // Inicialização do three.js
    function init() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x101820);
      
      camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
      camera.position.set(0, 2, 5);
      
      renderer = new THREE.WebGLRenderer({antialias:true});
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.getElementById('viewer').appendChild(renderer.domElement);
      
      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      
      // Iluminação
      const light = new THREE.DirectionalLight(0xffffff, 1);
      light.position.set(5,10,7);
      scene.add(light);
      
      const ambient = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(ambient);
      
      animate();
    }
    
    // Loop de animação
    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    
    // Limpar modelo atual
    function clearModel() {
      if (currentModel) {
        scene.remove(currentModel);
        currentModel.traverse && currentModel.traverse(obj => {
          if (obj.geometry) obj.geometry.dispose();
          if (obj.material) {
            if (Array.isArray(obj.material)) obj.material.forEach(m => m.dispose());
            else obj.material.dispose();
          }
        });
        currentModel = null;
      }
      showError('');
    }

    // Carregar modelo selecionado
    function loadSelectedModel() {
      clearModel();
      const path = document.getElementById('model-select').value;
      
      if (path.endsWith('.glb') || path.endsWith('.gltf')) {
        const loader = new GLTFLoader();
        loader.load(path, gltf => {
          currentModel = gltf.scene;
          scene.add(currentModel);
          showError('');
          console.log('✅ Modelo GLTF/GLB carregado:', path);
        }, undefined, err => {
          let msg = 'Erro ao carregar modelo GLTF/GLB: ' + (err && err.message ? err.message : err);
          fetch(path).then(r => {
            if (!r.ok) msg += `\nHTTP Status: ${r.status} ${r.statusText}`;
          }).catch(fetchErr => {
            msg += '\nFetch error: ' + fetchErr;
          }).finally(() => showError(msg));
        });
      } else if (path.endsWith('.fbx')) {
        const loader = new FBXLoader();
        loader.load(path, obj => {
          currentModel = obj;
          scene.add(currentModel);
          showError('');
          console.log('✅ Modelo FBX carregado:', path);
        }, undefined, err => {
          let msg = 'Erro ao carregar modelo FBX: ' + (err && err.message ? err.message : err);
          fetch(path).then(r => {
            if (!r.ok) msg += `\nHTTP Status: ${r.status} ${r.statusText}`;
          }).catch(fetchErr => {
            msg += '\nFetch error: ' + fetchErr;
          }).finally(() => showError(msg));
        });
      }
    }
    
    // Event listeners
    document.getElementById('load-model-btn').addEventListener('click', loadSelectedModel);

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
    
    // Inicializar aplicação
    init();
  </script>
</body>
</html>